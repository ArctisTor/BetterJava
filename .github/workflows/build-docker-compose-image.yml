name: Start Full Stack – JAR + BetterFront Image

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Build JAR on Master Merge"]
    types: [completed]
  workflow_dispatch:
  
permissions:
  contents: read
  actions: read          

jobs:
  prepare-and-run:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    steps:
    
      - name: Debug - List exact artifact names from the triggering run
        if: github.event_name == 'workflow_run'
        run: |
          echo "Triggering run ID: ${{ github.event.workflow_run.id }}"
          curl -fsSL \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts" \
          | jq -r '.artifacts[] | "→ Name: \(.name) | Size: \(.size_in_bytes) bytes | ID: \(.id)"'
            
      - name: Download JAR artifact (BetterJava-master)
        uses: dawidd6/action-download-artifact@v11
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}   # ← direct link to the run that just finished
          name: BetterJava-master                       # ← exact name your build workflow uploads
          path: jar
          if_no_artifact_found: fail


      - name: Verify JAR artifact was downloaded
        run: |
          if [ ! "$(ls -A jar)" ]; then
            echo "BetterJava-master artifact is missing or empty!"
            exit 1
          fi
          echo "JAR artifact downloaded successfully"

      - name: Download betterfront-docker-image
        uses: actions/download-artifact@v4
        with:
          name: betterfront-docker-image
          path: docker-image

      - name: Verify Docker image artifact was downloaded
        run: |
          if [ ! -f docker-image/betterfront-latest.tar ]; then
            echo "betterfront-docker-image artifact is missing or doesn't contain the .tar!"
            exit 1
          fi
          echo "Docker image artifact downloaded successfully"

      - name: Extract JAR and prepare Docker tar
        run: |
          # Extract JAR (handles zip or direct .jar)
          mkdir -p extracted-jar
          if compgen -G "jar/*.zip" > /dev/null; then
            unzip -o jar/*.zip -d extracted-jar/
          elif compgen -G "jar/*.jar" > /dev/null; then
            cp jar/*.jar extracted-jar/
          else
            echo "No JAR file found!"
            exit 1
          fi
          ls -la extracted-jar/

          mv docker-image/betterfront-latest.tar .

      - name: Load betterfront image
        run: docker load --input betterfront-latest.tar

      - name: Run docker compose (creates the final BetterJava image)
        run: docker compose up --build -d

      - name: Save ONLY the image created by docker-compose and upload it
        run: |
          IMAGE_NAME=$(docker compose ps -q betterjava | xargs docker inspect --format='{{.Image}}' | head -n1)
          IMAGE_TAG=$(docker inspect --format='{{index .RepoTags 0}}' "$IMAGE_NAME")
          docker save "$IMAGE_NAME" | gzip > betterjava-compose-image.tar.gz
          echo "Saved image: $IMAGE_TAG"   

      - name: Upload the final compose image
        uses: actions/upload-artifact@v4
        with:
          name: betterjava-compose-image
          path: betterjava-compose-image.tar.gz
          retention-days: 30

      
