name: Start Full Stack – JAR + BetterFront Image

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Build JAR on Master Merge"]
    types: [ completed ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  prepare-and-run:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'master')

    runs-on: ubuntu-latest

    steps:
      # ────────────────────────────────
      # THE ONLY STEP THAT ACTUALLY WORKS IN 2025
      # ────────────────────────────────
      - name: Download ALL artifacts from the triggering run (no name needed)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          path: downloaded-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Move the JAR (whatever its real name is) to where you expect it
      - name: Move the JAR into place
        run: |
          echo "All downloaded files:"
          find downloaded-artifacts -type f

          # Find the actual JAR file (there is only one)
          JAR_FILE=$(find downloaded-artifacts -type f -name "*.jar" | head -n1)
          
          if [[ -z "$JAR_FILE" ]]; then
            echo "No JAR file found!"
            exit 1
          fi
          
          mkdir -p jar
          cp "$JAR_FILE" jar/
          echo "JAR successfully placed in jar/ folder"
          ls -la jar/

      # ——— Rest of your workflow exactly as before ———
      - name: Download betterfront-docker-image
        uses: actions/download-artifact@v4
        with:
          name: betterfront-docker-image
          path: docker-image

      - name: Verify Docker image artifact was downloaded
        run: |
          if [ ! -f docker-image/betterfront-latest.tar ]; then
            echo "betterfront-docker-image artifact is missing!"
            exit 1
          fi

      - name: Extract JAR and prepare Docker tar
        run: |
          mkdir -p extracted-jar
          cp jar/*.jar extracted-jar/
          mv docker-image/betterfront-latest.tar .

      - name: Load betterfront image
        run: docker load --input betterfront-latest.tar

      - name: Run docker compose (creates the final BetterJava image)
        run: docker compose up --build -d

      - name: Save ONLY the image created by docker-compose
